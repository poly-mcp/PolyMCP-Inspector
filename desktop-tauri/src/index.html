<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyMCP Inspector</title>
  <script src="tauri://localhost/tauri.js"></script>
  <style>
    :root {
      --bg-1: #090d14;
      --bg-2: #0f1a2a;
      --line: #2a3c57;
      --text: #e8f0fa;
      --muted: #99abc4;
      --accent: #68d6ff;
      --danger: #ff8a8a;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: radial-gradient(1000px 600px at -10% -20%, #1b3555 0%, var(--bg-1) 45%), var(--bg-1); color: var(--text); font-family: "Segoe UI", sans-serif; overflow: hidden; }
    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(900px 520px at 120% -20%, #14253b 0%, transparent 60%), linear-gradient(180deg, var(--bg-2) 0%, var(--bg-1) 100%);
      z-index: 10;
      transition: opacity 0.28s ease;
    }
    .splash.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .card {
      width: min(520px, calc(100vw - 48px));
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(12, 20, 33, 0.86);
      backdrop-filter: blur(8px);
      padding: 28px;
      text-align: center;
    }
    .brand {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
    }
    .spinner {
      width: 46px;
      height: 46px;
      margin: 0 auto 14px;
      border-radius: 999px;
      border: 3px solid #2f4668;
      border-top-color: var(--accent);
      animation: spin 0.85s linear infinite;
    }
    .status {
      font-size: 14px;
      font-weight: 600;
      min-height: 22px;
    }
    .status.error { color: var(--danger); }
    .retry {
      margin-top: 14px;
      border: 1px solid var(--line);
      background: #18273d;
      color: var(--text);
      border-radius: 9px;
      padding: 9px 14px;
      font-weight: 600;
      cursor: pointer;
      display: none;
    }
    .retry:hover { border-color: var(--accent); }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="splash" class="splash">
    <div class="card">
      <div class="brand">PolyMCP Inspector</div>
      <div class="subtitle">Starting local runtime</div>
      <div class="spinner"></div>
      <div id="status" class="status">Preparing backend...</div>
      <button id="retryBtn" class="retry">Retry</button>
    </div>
  </div>
  <script>
    const splashEl = document.getElementById('splash');
    const statusEl = document.getElementById('status');
    const retryBtn = document.getElementById('retryBtn');

    let bootInProgress = false;

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.className = 'status' + (isError ? ' error' : '');
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    function getTauriInvoke() {
      const t = window.__TAURI__;
      if (!t) return null;
      if (typeof t.invoke === 'function') return t.invoke;
      if (t.tauri && typeof t.tauri.invoke === 'function') return t.tauri.invoke;
      return null;
    }

    function uid() {
      try {
        return window.crypto.getRandomValues(new Uint32Array(1))[0];
      } catch {
        return Math.floor(Math.random() * 0xffffffff);
      }
    }

    function transformCallback(callback, once = false) {
      const identifier = uid();
      const prop = `_${identifier}`;
      Object.defineProperty(window, prop, {
        value: (result) => {
          if (once) {
            Reflect.deleteProperty(window, prop);
          }
          return callback(result);
        },
        writable: false,
        configurable: true
      });
      return identifier;
    }

    function ipcInvoke(cmd, args = {}) {
      return new Promise((resolve, reject) => {
        const callback = transformCallback((e) => {
          resolve(e);
          Reflect.deleteProperty(window, `_${error}`);
        }, true);
        const error = transformCallback((e) => {
          reject(e);
          Reflect.deleteProperty(window, `_${callback}`);
        }, true);
        window.__TAURI_IPC__({
          cmd,
          callback,
          error,
          ...(args || {})
        });
      });
    }

    function resolveInvoke() {
      const invoke = getTauriInvoke();
      if (invoke) return invoke;
      if (typeof window.__TAURI_IPC__ === 'function') {
        return (cmd, args) => ipcInvoke(cmd, args);
      }
      return null;
    }

    async function getInspectorUrl(invoke) {
      const deadline = Date.now() + 40000;
      let lastError = '';
      while (Date.now() < deadline) {
        try {
          const url = await invoke('get_inspector_url');
          if (url) return url;
        } catch (err) {
          lastError = String(err);
        }
        await sleep(250);
      }
      throw new Error(lastError || 'Backend did not become ready in time');
    }

    async function boot() {
      if (bootInProgress) return;
      bootInProgress = true;
      retryBtn.style.display = 'none';
      setStatus('Preparing backend...');
      splashEl.classList.remove('hidden');

      try {
        const invoke = resolveInvoke();
        if (!invoke) {
          throw new Error('Tauri API not available');
        }

        const inspectorUrl = await getInspectorUrl(invoke);
        setStatus('Opening interface...');
        setTimeout(() => {
          window.location.replace(inspectorUrl);
        }, 80);
      } catch (err) {
        setStatus('Startup failed. Retry.', true);
        retryBtn.style.display = 'inline-block';
        console.error(err);
      } finally {
        bootInProgress = false;
      }
    }

    retryBtn.addEventListener('click', () => boot());
    boot();
  </script>
</body>
</html>
